name: DevOps Infrastructure Automation

on:
  push:
    branches: [ main, develop, devops-1 ]
    paths:
      - 'devops-1/**'
      - '.github/workflows/devops-1-workflow.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'devops-1/**'
      - '.github/workflows/devops-1-workflow.yml'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'dev'
        type: choice
        options:
        - dev
        - staging
        - prod

env:
  AWS_REGION: ap-northeast-2
  TF_VERSION: "1.5.0"

jobs:
  validate:
    name: Validate Infrastructure Code
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: ${{ env.TF_VERSION }}
    
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}
    
    - name: Debug íŒŒì¼ êµ¬ì¡°
      working-directory: ./devops-1
      run: |
        echo "ğŸ·ï¸ í˜„ì¬ ì‘ì—… ë””ë ‰í„°ë¦¬: $(pwd)"
        echo "ğŸ“‚ devops-1 í´ë” êµ¬ì¡°:"
        ls -la
        echo ""
        echo "ğŸ“ terraform í´ë” í™•ì¸:"
        if [ -d "terraform" ]; then
          ls -la terraform/
          echo ""
          echo "ğŸ” .tf íŒŒì¼ ê²€ìƒ‰:"
          find terraform -name "*.tf" -type f 2>/dev/null || echo "No .tf files found"
        else
          echo "âŒ terraform í´ë”ê°€ ì—†ìŠµë‹ˆë‹¤!"
        fi
    
    - name: Terraform Format Check
      working-directory: ./devops-1/terraform
      run: terraform fmt -check -recursive
    
    - name: Terraform Init
      working-directory: ./devops-1/terraform
      run: |
        terraform init
        terraform validate
    
    - name: Terraform Plan
      working-directory: ./devops-1/terraform
      run: terraform plan -out=tfplan
      env:
        AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
        AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        AWS_DEFAULT_REGION: ${{ env.AWS_REGION }}
    
    - name: Upload Terraform Plan
      uses: actions/upload-artifact@v4
      with:
        name: terraform-plan
        path: ./devops-1/terraform/tfplan

  # Security scan removed - DevSecOps project handles security scanning

  deploy-infrastructure:
    name: Deploy Infrastructure
    runs-on: ubuntu-latest
    needs: [validate]
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/devops-1' || github.event_name == 'workflow_dispatch'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}
    
    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: ${{ env.TF_VERSION }}
    
    - name: Download Terraform Plan
      uses: actions/download-artifact@v4
      with:
        name: terraform-plan
        path: ./devops-1/terraform/
    
    - name: Terraform Init
      working-directory: ./devops-1/terraform
      run: terraform init
    
    - name: Terraform Apply
      working-directory: ./devops-1/terraform
      run: terraform apply tfplan
      env:
        AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
        AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        AWS_DEFAULT_REGION: ${{ env.AWS_REGION }}
    
    - name: Save Terraform outputs
      working-directory: ./devops-1/terraform
      run: |
        if [ -f "save_outputs.sh" ]; then
          chmod +x save_outputs.sh
          ./save_outputs.sh
        fi

  deploy-application:
    name: Deploy Application
    runs-on: ubuntu-latest
    needs: [deploy-infrastructure]
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/devops-1' || github.event_name == 'workflow_dispatch'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}
    
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install Ansible and AWS plugins
      run: |
        python -m pip install --upgrade pip
        pip install ansible boto3
        ansible-galaxy collection install amazon.aws
    
    - name: Setup Terraform for outputs
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: ${{ env.TF_VERSION }}
    
    - name: Generate Terraform outputs
      working-directory: ./devops-1/terraform
      run: |
        terraform init
        terraform output -json > ../ansible/terraform_outputs.json
        echo "âœ… Terraform outputs generated"
    
    - name: Setup SSH key
      working-directory: ./devops-1/ansible
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        eval "$(ssh-agent -s)"
        ssh-add ~/.ssh/id_rsa
        echo "SSH key setup completed"
        echo "ğŸ”‘ SSH í‚¤ ì •ë³´:"
        ls -la ~/.ssh/
        ssh-add -l
        echo ""
        echo "ğŸ” AWS í‚¤ í˜ì–´ ì •ë³´:"
        aws ec2 describe-key-pairs --query 'KeyPairs[?contains(KeyName, `saju-app-key`)].{KeyName:KeyName,KeyFingerprint:KeyFingerprint}' --output table
        echo ""
        echo "ğŸ” SSH í‚¤ ì§€ë¬¸ í™•ì¸:"
        ssh-keygen -lf ~/.ssh/id_rsa || echo "SSH í‚¤ ì§€ë¬¸ í™•ì¸ ì‹¤íŒ¨"
    
    - name: Debug AWS EC2 inventory
      working-directory: ./devops-1/ansible
      run: |
        echo "ğŸ” Testing AWS EC2 inventory..."
        ansible-inventory -i inventories/aws_ec2.yml --list
        echo "âœ… AWS EC2 inventory test completed"
        
        echo "ğŸ” Getting EC2 instance information..."
        WEB1_IP=$(aws ec2 describe-instances --filters "Name=tag:Name,Values=webserver1" "Name=instance-state-name,Values=running" --query 'Reservations[0].Instances[0].PublicIpAddress' --output text)
        WEB2_IP=$(aws ec2 describe-instances --filters "Name=tag:Name,Values=webserver2" "Name=instance-state-name,Values=running" --query 'Reservations[0].Instances[0].PublicIpAddress' --output text)
        
        echo "ğŸŒ Webserver1 IP: $WEB1_IP"
        echo "ğŸŒ Webserver2 IP: $WEB2_IP"
        
        if [ "$WEB1_IP" != "None" ] && [ "$WEB1_IP" != "" ]; then
          echo "ğŸ” Testing SSH connection to webserver1 ($WEB1_IP)..."
          ssh -o StrictHostKeyChecking=no -o ConnectTimeout=10 -i ~/.ssh/id_rsa -v ubuntu@$WEB1_IP "echo 'SSH connection successful'" || echo "SSH connection to webserver1 failed"
        else
          echo "âŒ Webserver1 IP not found or instance not running"
        fi
        
        if [ "$WEB2_IP" != "None" ] && [ "$WEB2_IP" != "" ]; then
          echo "ğŸ” Testing SSH connection to webserver2 ($WEB2_IP)..."
          ssh -o StrictHostKeyChecking=no -o ConnectTimeout=10 -i ~/.ssh/id_rsa -v ubuntu@$WEB2_IP "echo 'SSH connection successful'" || echo "SSH connection to webserver2 failed"
        else
          echo "âŒ Webserver2 IP not found or instance not running"
        fi
    
    - name: Deploy with Ansible
      working-directory: ./devops-1/ansible
      run: |
        echo "ğŸš€ Ansible ë°°í¬ ì‹œì‘..."
        echo "ğŸ“ í˜„ì¬ ì‘ì—… ë””ë ‰í„°ë¦¬: $(pwd)"
        echo "ğŸ”‘ SSH í‚¤ ê²½ë¡œ: ~/.ssh/id_rsa"
        echo "ğŸ“‹ ì¸ë²¤í† ë¦¬ íŒŒì¼: inventories/aws_ec2.yml"
        echo "ğŸ“„ í”Œë ˆì´ë¶ íŒŒì¼: playbook.yml"
        
        ansible-playbook -i inventories/aws_ec2.yml playbook.yml \
          -e "env=${{ github.event.inputs.environment || 'dev' }}" \
          --private-key ~/.ssh/id_rsa \
          -v
      env:
        ANSIBLE_HOST_KEY_CHECKING: False

  notify:
    name: Notify Deployment Status
    runs-on: ubuntu-latest
    needs: [deploy-application]
    if: always()
    
    steps:
    - name: Notify on Success
      if: needs.deploy-application.result == 'success'
      run: |
        echo "âœ… DevOps deployment completed successfully!"
        echo "Environment: ${{ github.event.inputs.environment || 'dev' }}"
    
    - name: Notify on Failure
      if: needs.deploy-application.result == 'failure'
      run: |
        echo "âŒ DevOps deployment failed!"
        echo "Environment: ${{ github.event.inputs.environment || 'dev' }}"
        exit 1 