import json
from datetime import datetime
from typing import List, Dict, Optional

def generate_final_report(
    vuln_list: List[Dict], 
    target_system: str = "ì›¹ ì• í”Œë¦¬ì¼€ì´ì…˜",
    image_filename: str = "unknown.jpg",
    author: str = "ë³´ì•ˆì§„ë‹¨íŒ€"
) -> str:
    """
    Vision-LLMìœ¼ë¡œ ë¶„ì„ëœ ì·¨ì•½ì  ë°ì´í„°ë¥¼ ë°”íƒ•ìœ¼ë¡œ ìµœì¢… Markdown ë³´ê³ ì„œë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
    
    Args:
        vuln_list: ì·¨ì•½ì  ë¶„ì„ ê²°ê³¼ JSON ë°°ì—´
        target_system: ëŒ€ìƒ ì‹œìŠ¤í…œëª…
        image_filename: ì›ë³¸ ì§„ë‹¨ ì´ë¯¸ì§€ íŒŒì¼ëª…
        author: ë³´ê³ ì„œ ì‘ì„±ì/íŒ€
    
    Returns:
        str: Markdown í˜•ì‹ì˜ ìµœì¢… ë³´ê³ ì„œ
    """
    
    if not vuln_list:
        return "# âŒ ì·¨ì•½ì  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.\n\në¶„ì„í•  ì·¨ì•½ì ì´ ë°œê²¬ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
    
    today = datetime.now().strftime("%Y-%m-%d")
    
    # 1. ë³´ê³ ì„œ ê°œìš”
    report = f"""# â–¶ ì›¹ ì·¨ì•½ì  ì¢…í•© ë³´ê³ ì„œ

## 1. ë³´ê³ ì„œ ê°œìš”

* **ì‘ì„±ì¼**: {today}
* **ì‘ì„±ì/íŒ€**: {author}
* **ëŒ€ìƒ ì‹œìŠ¤í…œ**: {target_system} ì¸ì¦Â·ì—…ë¡œë“œÂ·ê´€ë¦¬ ê¸°ëŠ¥
* **ë³´ê³  ëª©ì **: ì§„ë‹¨ëœ ì·¨ì•½ì ì„ í†µí•´ ì¡°ì§ì›ì˜ ë³´ì•ˆì •ì±… ì¤€ìˆ˜ ì˜ì§€ë¥¼ ê°•í™”í•˜ê³ , ë³´í˜¸ë™ê¸° ì´ë¡ (PMT) ê¸°ë°˜ ì‹¤í–‰ ì „ëµì„ ì œì‹œ

---

## 2. ì·¨ì•½ì  ìš”ì•½ Table

| ì·¨ì•½ì  ID   | ìœ í˜•                | ì‹¬ê°ë„ | ë°œê²¬ ëª¨ë“ˆ/URL                        | ìš”ì•½ ì„¤ëª…                                |
| -------- | ----------------- | --- | -------------------------------- | ------------------------------------ |
"""
    
    # 2. ì·¨ì•½ì  ìš”ì•½ í…Œì´ë¸”
    for vuln in vuln_list:
        report += f"| {vuln.get('id', 'N/A')} | {vuln.get('type', 'N/A')} | {vuln.get('severity', 'N/A')} | {vuln.get('module', 'N/A')} | {vuln.get('summary', 'N/A')} |\n"
    
    report += "\n---\n\n## 3. ì·¨ì•½ì ë³„ ìœ„í—˜ì„± ë° ìœ ì‚¬ í•´í‚¹ ì‚¬ê³  ì‚¬ë¡€\n\n"
    report += "ê° ì·¨ì•½ì ì— ëŒ€í•´ \"ìœ„í—˜ì„±(5ì¤„ ì´ìƒ)\"ê³¼ \"ìœ ì‚¬ í•´í‚¹ ì‚¬ê³  ì‚¬ë¡€(1ê±´, 5ì¤„ ì´ìƒ)\"ë¥¼ í•œ ë¬¶ìŒìœ¼ë¡œ ì •ë¦¬í–ˆìŠµë‹ˆë‹¤.\n\n"
    
    # 3. ì·¨ì•½ì ë³„ ìœ„í—˜ì„± ë° ìœ ì‚¬ í•´í‚¹ ì‚¬ê³  ì‚¬ë¡€
    for vuln in vuln_list:
        vuln_type = vuln.get('type', 'N/A')
        report += f"### {vuln_type}\n\n"
        
        # ìœ„í—˜ì„±
        report += "**ìœ„í—˜ì„±**\n"
        risk = vuln.get('risk', 'ìœ„í—˜ì„± ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.')
        report += f"{risk}\n\n"
        
        # ìœ ì‚¬ í•´í‚¹ ì‚¬ê³  ì‚¬ë¡€
        report += "**ìœ ì‚¬ í•´í‚¹ ì‚¬ê³  ì‚¬ë¡€**\n"
        incidents = vuln.get('incidents', [])
        if incidents:
            incident = incidents[0]  # ì²« ë²ˆì§¸ ì‚¬ë¡€ë§Œ ì‚¬ìš©
            report += f"**{incident.get('name', 'N/A')} ({incident.get('date', 'N/A')})**\n"
            report += f"{incident.get('summary', 'í”¼í•´ ìš”ì•½ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.')}\n\n"
        else:
            report += "ê´€ë ¨ ì‚¬ê³  ì‚¬ë¡€ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.\n\n"
        
        report += "---\n\n"
    
    report += "## 4. ê²½ì˜ì§„ ë³´ê³ ì‚¬í•­ (Management Brief)\n\n"
    
    # 4. ê²½ì˜ì§„ ë³´ê³ ì‚¬í•­
    high_severity = [v for v in vuln_list if v.get('severity') == 'ë†’ìŒ']
    medium_severity = [v for v in vuln_list if v.get('severity') == 'ì¤‘ê°„']
    
    report += "**ì·¨ì•½ì  ì‹¬ê°ë„ ìš”ì•½**\n\n"
    report += "* 'ë†’ìŒ': "
    high_types = [v.get('type') for v in high_severity]
    report += ", ".join(high_types) if high_types else "ì—†ìŒ"
    report += " â†’ ì¦‰ì‹œ íŒ¨ì¹˜\n"
    
    report += "* 'ì¤‘ê°„': "
    medium_types = [v.get('type') for v in medium_severity]
    report += ", ".join(medium_types) if medium_types else "ì—†ìŒ"
    report += " â†’ ë‹¨ê¸° ë³´ê°•\n\n"
    
    report += "**APT ê³µê²© ì‹œë‚˜ë¦¬ì˜¤**\n"
    report += "ê³µê²©ìëŠ” ë¨¼ì € ì¸ì¦ ìš°íšŒ ì·¨ì•½ì ì„ ì´ìš©í•´ ê´€ë¦¬ì ê¶Œí•œì„ íšë“í•©ë‹ˆë‹¤. ì´í›„ íŒŒì¼ ì—…ë¡œë“œ ê²€ì¦ ë¯¸í¡ ì·¨ì•½ì ì„ í†µí•´ ì›¹ ì…¸ì„ ì„œë²„ì— ì—…ë¡œë“œí•˜ì—¬ ì›ê²© ì½”ë“œ ì‹¤í–‰ ê¶Œí•œì„ í™•ë³´í•©ë‹ˆë‹¤. ì´ ê¶Œí•œì„ í™œìš©í•´ í¬ë¡œìŠ¤ì‚¬ì´íŠ¸ ìŠ¤í¬ë¦½íŒ…ê³¼ ì •ë³´ ëˆ„ì¶œ ì·¨ì•½ì ì„ ì—°ê³„, ì„¸ì…˜ ì¿ í‚¤ì™€ ë‚´ë¶€ ë¡œê·¸ë¥¼ íƒˆì·¨Â·ë¶„ì„í•˜ì—¬ ë„¤íŠ¸ì›Œí¬ ë‚´ë¶€ë¡œ ìˆ˜í‰ ì´ë™í•©ë‹ˆë‹¤. ë„¤íŠ¸ì›Œí¬ì— ì§„ì…í•œ ê³µê²©ìëŠ” ê´€ë¦¬ì í˜ì´ì§€ ë…¸ì¶œ ì·¨ì•½ì ì„ ë‚¨ìš©í•´ ì„œë¹„ìŠ¤ ì„¤ì •ì„ ì™„ì „íˆ ë³€ê²½í•˜ê³  ë°±ì—… ë°ì´í„°ë¥¼ ì‚­ì œÂ·ì•”í˜¸í™”í•©ë‹ˆë‹¤. ë§ˆì§€ë§‰ìœ¼ë¡œ ì•…ì„± ì½˜í…ì¸  ì‚½ì… ì·¨ì•½ì ì„ í†µí•´ ëœì„¬ì›¨ì–´ë¥¼ ë°°í¬í•˜ê±°ë‚˜ ëŒ€ëŸ‰ì˜ ê³ ê° ë°ì´í„°ë¥¼ ìœ ì¶œí•˜ì—¬ ì„œë¹„ìŠ¤ ë§ˆë¹„ì™€ í‰íŒ ì†ìƒì„ ë™ì‹œì— ì¼ìœ¼í‚µë‹ˆë‹¤.\n\n"
    
    report += "**ì¦‰ì‹œ ëŒ€ì‘ (0â€“7ì¼)**\n\n"
    report += "* ëª¨ë“  ì·¨ì•½ì  ì—”ë“œí¬ì¸íŠ¸ ë° ê´€ë¦¬ì URL ì™¸ë¶€ ì ‘ê·¼ ì°¨ë‹¨\n"
    report += "* WAF ê·œì¹™ìœ¼ë¡œ ë³€ìˆ˜ ì¡°ì‘Â·ìŠ¤í¬ë¦½íŠ¸ ì‚½ì… ìš”ì²­ ì°¨ë‹¨\n"
    report += "* 24ì‹œê°„ ë‚´ ê¸´ê¸‰ íŒ¨ì¹˜ ì™„ë£Œ ë° ëª¨ì˜ í•´í‚¹ ì¬ê²€ì¦\n\n"
    
    report += "**ë‹¨ê¸° ê°•í™” (1â€“3ì£¼)**\n\n"
    report += "* ì „ì‚¬ ì½”ë“œ ë¦¬ë·° ë° ìë™í™” ìŠ¤ìº” ë„êµ¬ ë„ì…\n"
    report += "* ì „ ì§ì› ëŒ€ìƒ ë³´ì•ˆ ì¸ì‹ êµìœ¡ ë° ëª¨ì˜ í•´í‚¹ ì›Œí¬ìˆ\n\n"
    
    report += "**ì¤‘ì¥ê¸° ì²´ê³„í™” (1â€“3ê°œì›”+)**\n\n"
    report += "* ë³´ì•ˆ KPI ì„¤ì • ë° ë¶„ê¸°ë³„ CISO ê²€í†  íšŒì˜ ì œë„í™”\n"
    report += "* SOCÂ·SIEM ê³ ë„í™”, ì™¸ë¶€ ë³´ì•ˆ ì¸ì¦(ISMS-P ë“±) ì¤€ë¹„\n\n"
    
    report += "---\n\n## 5. ë©”íƒ€ì¸ì§€ êµìœ¡ ì œì•ˆ (Metacognition Training)\n\n"
    report += "> **ëª©í‘œ**: ì „ì§ì› ëŒ€ìƒ ë©”íƒ€ì¸ì§€ ì—­ëŸ‰ ê°•í™”ë¡œ ìë°œì  ìœ„í—˜ íƒì§€Â·ë³´ê³  ë¬¸í™” ì¡°ì„±\n\n"
    
    # 5. ë©”íƒ€ì¸ì§€ êµìœ¡ ì œì•ˆ
    report += "1. **êµìœ¡ ëª©í‘œ**: 'ë‚´ê°€ ë³´ëŠ” ì •ë³´ì˜ ì•ˆì „ì„±'ì„ ìŠ¤ìŠ¤ë¡œ ì ê²€í•˜ê³  ì´ìƒ ì§•í›„ë¥¼ ì¡°ê¸°ì— ì‹ë³„\n"
    report += "2. **ì»¤ë¦¬í˜ëŸ¼**:\n\n"
    report += "   * **ìœ„í˜‘ ëª¨ë¸ë§ ì›Œí¬ìˆ**: ì‹¤ì œ ì·¨ì•½ì  ì‚¬ë¡€ ë¶„ì„ ë° ë¦¬ìŠ¤í¬ ë§¤í•‘\n"
    report += "   * **ëª¨ì˜í•´í‚¹ ì‹¤ìŠµ**: XSSÂ·RCE ì‹œë‚˜ë¦¬ì˜¤ êµ¬ì„± ë° ëŒ€ì‘ ê²½í—˜\n"
    report += "   * **ì¸ì§€ íšŒê³  ì„¸ì…˜**: íƒì§€ ê³¼ì • ê¸°ë¡ í›„ íŒ€ë³„ ê³µìœ Â·í”¼ë“œë°±\n"
    report += "   * **í€´ì¦ˆ ê¸°ë°˜ ì ê²€**: ë¹„ì •í˜• ì·¨ì•½ì  íƒì§€ ëŠ¥ë ¥ ê²€ì¦\n"
    report += "   * **í–‰ë™ ì²´í¬ë¦¬ìŠ¤íŠ¸**: ë°°í¬ ì „ í•„ìˆ˜ ë³´ì•ˆ ì ê²€ ë¦¬ìŠ¤íŠ¸ ì‹¤ìŠµ\n"
    report += "3. **ê¸°ëŒ€ íš¨ê³¼**:\n\n"
    report += "   * ì·¨ì•½ì  íƒì§€ ì†ë„ 50% ë‹¨ì¶•\n"
    report += "   * ìë°œì  ë³´ì•ˆ ë¦¬í¬íŠ¸ ì œì¶œ ê±´ìˆ˜ 2ë°° ì¦ê°€\n"
    report += "   * ì‚¬ê³  ëŒ€ì‘ ì‹œê°„ í‰ê·  40% ê°œì„ \n\n"
    
    report += "---\n\n## 6. ì¢…í•© ëŒ€ì‘ ë¡œë“œë§µ (Comprehensive Response Roadmap)\n\n"
    
    # 6. ì¢…í•© ëŒ€ì‘ ë¡œë“œë§µ
    report += """| ë‹¨ê³„         | ê¸°ê°„     | ì£¼ìš” í™œë™                                                                     | ë‹´ë‹¹ ì¡°ì§/íŒ€     |
| ---------- | ------ | ------------------------------------------------------------------------- | ----------- |
| **ê¸´ê¸‰ ëŒ€ì‘**  | 0â€“7ì¼   | - ì·¨ì•½ì  íŒ¨ì¹˜ ë° WAF ê·œì¹™ ì¦‰ì‹œ ì ìš©<br>- ìœ„í—˜ ì—”ë“œí¬ì¸íŠ¸ ì°¨ë‹¨<br>- ê¸´ê¸‰ ëª¨ì˜í•´í‚¹ ì‹¤ì‹œ                  | ë³´ì•ˆíŒ€Â·ê°œë°œíŒ€Â·SOC |
| **ë‹¨ê¸° ê°•í™”**  | 1â€“3ì£¼   | - ì½”ë“œ ë¦¬ë·° ë° ìŠ¤ìº” ìë™í™” ë„ì…<br>- ì „ ì§ì› ë³´ì•ˆ ì¸ì‹ êµìœ¡Â·ì›Œí¬ìˆ ì‹¤ì‹œ                             | ê°œë°œíŒ€Â·êµìœ¡íŒ€     |
| **ì¤‘ê¸° ì²´ê³„í™”** | 1â€“3ê°œì›”  | - ë³´ì•ˆ ê±°ë²„ë„ŒìŠ¤ ê°•í™”(KPI í¬í•¨)<br>- ë¶„ê¸°ë³„ CISO ê²€í†  íšŒì˜ ì œë„í™”<br>- SOCÂ·SIEM ê³ ë„í™”            | ì „ëµíŒ€Â·ê±°ë²„ë„ŒìŠ¤íŒ€   |
| **ì¥ê¸° ê°œì„ **  | 3â€“6ê°œì›”+ | - Red TeamÂ·Blue Team í›ˆë ¨<br>- ì˜¨í”„ë ˆë¯¸ìŠ¤ LLM ê²€í† <br>- ì™¸ë¶€ ë³´ì•ˆ ì¸ì¦ ì¤€ë¹„<br>- ë³´ì•ˆ ì„±ìˆ™ë„ í‰ê°€ | ë³´ì•ˆì „ëµíŒ€Â·ê°ì‚¬íŒ€   |

---

*End of Report*
"""
    
    return report

def generate_executive_summary(vuln_list: List[Dict]) -> str:
    """
    ê²½ì˜ì§„ì„ ìœ„í•œ ì‹¤í–‰ ìš”ì•½ì„ ìƒì„±í•©ë‹ˆë‹¤.
    
    Args:
        vuln_list: ì·¨ì•½ì  ë¶„ì„ ê²°ê³¼ JSON ë°°ì—´
    
    Returns:
        str: ì‹¤í–‰ ìš”ì•½ Markdown
    """
    
    if not vuln_list:
        return "# ì‹¤í–‰ ìš”ì•½\n\në¶„ì„ëœ ì·¨ì•½ì ì´ ì—†ìŠµë‹ˆë‹¤."
    
    high_severity = [v for v in vuln_list if v.get('severity') == 'ë†’ìŒ']
    medium_severity = [v for v in vuln_list if v.get('severity') == 'ì¤‘ê°„']
    low_severity = [v for v in vuln_list if v.get('severity') == 'ë‚®ìŒ']
    
    summary = f"""# ğŸ“Š ì‹¤í–‰ ìš”ì•½

## ì·¨ì•½ì  í˜„í™©

* **ì´ ì·¨ì•½ì  ìˆ˜**: {len(vuln_list)}ê°œ
* **ë†’ì€ ì‹¬ê°ë„**: {len(high_severity)}ê°œ
* **ì¤‘ê°„ ì‹¬ê°ë„**: {len(medium_severity)}ê°œ  
* **ë‚®ì€ ì‹¬ê°ë„**: {len(low_severity)}ê°œ

## ì£¼ìš” ì·¨ì•½ì  ìœ í˜•

"""
    
    vuln_types = {}
    for vuln in vuln_list:
        vuln_type = vuln.get('type', 'Unknown')
        vuln_types[vuln_type] = vuln_types.get(vuln_type, 0) + 1
    
    for vuln_type, count in vuln_types.items():
        summary += f"* **{vuln_type}**: {count}ê°œ\n"
    
    summary += "\n## ê¸´ê¸‰ ì¡°ì¹˜ í•„ìš” ì‚¬í•­\n\n"
    
    if high_severity:
        summary += "### ğŸ”´ ë†’ì€ ì‹¬ê°ë„ ì·¨ì•½ì \n\n"
        for vuln in high_severity:
            summary += f"* **{vuln.get('id')}** - {vuln.get('type')}: {vuln.get('summary')}\n"
        summary += "\n"
    
    summary += "## ê¶Œê³ ì‚¬í•­\n\n"
    summary += "1. **ì¦‰ì‹œ ì¡°ì¹˜**: ë†’ì€ ì‹¬ê°ë„ ì·¨ì•½ì  ìš°ì„  íŒ¨ì¹˜\n"
    summary += "2. **ë‹¨ê¸° ì¡°ì¹˜**: ë³´ì•ˆ ëª¨ë‹ˆí„°ë§ ê°•í™” ë° ì ‘ê·¼ ì œì–´\n"
    summary += "3. **ì¤‘ì¥ê¸° ì¡°ì¹˜**: ë³´ì•ˆ ì•„í‚¤í…ì²˜ ì¬ì„¤ê³„ ë° êµìœ¡ í”„ë¡œê·¸ë¨ ìš´ì˜\n\n"
    
    summary += f"---\n\n*ìƒì„±ì¼: {datetime.now().strftime('%Yë…„ %mì›” %dì¼ %H:%M')}*"
    
    return summary 