name: DevSecOps Pipeline

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'devsecops-2/**'
  pull_request:
    branches: [ main ]
    paths:
      - 'devsecops-2/**'

env:
  AWS_REGION: ap-northeast-2
  TF_VERSION: '1.5.0'

jobs:
  trivy-fs-scan:
    name: Trivy File System Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3
      - name: Run Trivy vulnerability scanner (File System)
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH,MEDIUM,LOW'
      - name: Upload Trivy scan results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'
      - name: Upload Trivy FS results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: trivy-fs-results
          path: trivy-results.sarif
      - name: Generate Trivy FS Summary
        if: always()
        run: |
          echo "## üîç Trivy File System Scan Results" >> $GITHUB_STEP_SUMMARY
          if [ -f trivy-results.sarif ]; then
            echo "‚úÖ File system scan completed successfully" >> $GITHUB_STEP_SUMMARY
            echo "üìÅ Results uploaded to GitHub Security tab" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå File system scan failed or no results generated" >> $GITHUB_STEP_SUMMARY
          fi

  trivy-iac-scan:
    name: Trivy IaC Scan
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./devsecops-2
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3
      - name: Set up Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
      - name: Run Trivy for Infrastructure as Code
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'config'
          scan-ref: 'terraform/'
          format: 'sarif'
          output: 'trivy-iac-results.sarif'
          severity: 'CRITICAL,HIGH,MEDIUM,LOW'
      - name: Upload Trivy IaC results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: trivy-iac-results
          path: trivy-iac-results.sarif
      - name: Generate Trivy IaC Summary
        if: always()
        run: |
          echo "## üèóÔ∏è Trivy Infrastructure as Code Scan Results" >> $GITHUB_STEP_SUMMARY
          if [ -f trivy-iac-results.sarif ]; then
            echo "‚úÖ IaC scan completed successfully" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå IaC scan failed or no results generated" >> $GITHUB_STEP_SUMMARY
          fi

  ai-security-report:
    name: AI Security Report
    runs-on: ubuntu-latest
    needs: [trivy-fs-scan, trivy-iac-scan]
    if: needs.trivy-fs-scan.result == 'success' && needs.trivy-iac-scan.result == 'success'
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
      - name: Download Trivy FS results
        uses: actions/download-artifact@v4
        with:
          name: trivy-fs-results
          path: .
      - name: Download Trivy IaC results
        uses: actions/download-artifact@v4
        with:
          name: trivy-iac-results
          path: .
      - name: Generate AI Security Report
        run: |
          python3 generate_security_report.py
      - name: Upload AI Security Report
        uses: actions/upload-artifact@v4
        with:
          name: trivy-ai-security-report
          path: trivy-security-report.md
      - name: Generate Final AI Summary
        run: |
          echo "## ü§ñ AI Security Scan Complete" >> $GITHUB_STEP_SUMMARY
          echo "### Overall Status: ‚úÖ PASSED" >> $GITHUB_STEP_SUMMARY
          echo "### üìã Job Results:" >> $GITHUB_STEP_SUMMARY
          echo "- Trivy File System Scan: ${{ needs.trivy-fs-scan.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Trivy IaC Scan: ${{ needs.trivy-iac-scan.result }}" >> $GITHUB_STEP_SUMMARY
          echo "### üìä Reports Available:" >> $GITHUB_STEP_SUMMARY
          echo "- ü§ñ AI Security Report (trivy-security-report.md)" >> $GITHUB_STEP_SUMMARY
          echo "- GitHub Security Tab" >> $GITHUB_STEP_SUMMARY
          echo "- Workflow Artifacts" >> $GITHUB_STEP_SUMMARY

  validate-infrastructure:
    name: Validate Infrastructure Code
    runs-on: ubuntu-latest
    needs: [ai-security-report]
    if: needs.ai-security-report.result == 'success'
    defaults:
      run:
        working-directory: ./devsecops-2
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
      - name: Terraform Format Check
        run: terraform fmt -check -recursive
      - name: Terraform Init
        run: |
          terraform init
          terraform validate
      - name: Terraform Plan
        run: |
          terraform plan -out=tfplan
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: ${{ env.AWS_REGION }}

  deploy-infrastructure:
    name: Deploy Infrastructure
    runs-on: ubuntu-latest
    needs: [validate-infrastructure]
    if: needs.validate-infrastructure.result == 'success'
    defaults:
      run:
        working-directory: ./devsecops-2
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
      - name: Terraform Init
        run: |
          terraform init
      - name: Terraform Apply
        run: |
          terraform apply -auto-approve
      - name: Save Terraform outputs
        run: |
          if [ -f "save_outputs.sh" ]; then
            chmod +x save_outputs.sh
            ./save_outputs.sh
          fi

  deploy-application:
    name: Deploy Security Scanner Application
    runs-on: ubuntu-latest
    needs: [deploy-infrastructure]
    if: needs.deploy-infrastructure.result == 'success'
    defaults:
      run:
        working-directory: ./devsecops-2
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
      - name: Install Ansible
        run: |
          python -m pip install --upgrade pip
          pip install ansible boto3
      - name: Deploy with Ansible
        run: |
          cd ansible
          ansible-playbook -i inventories/aws_ec2.yml playbook.yml
        env:
          ANSIBLE_HOST_KEY_CHECKING: False

  notify:
    name: Notify Deployment Status
    runs-on: ubuntu-latest
    needs: [deploy-application, ai-security-report]
    if: always()
    steps:
      - name: Notify on Success
        if: needs.deploy-application.result == 'success' && needs.ai-security-report.result == 'success'
        run: |
          echo "‚úÖ DevSecOps deployment completed successfully!"
          echo "Security scan and infrastructure deployment completed"
      - name: Notify on Failure
        if: needs.deploy-application.result == 'failure' || needs.ai-security-report.result == 'failure'
        run: |
          echo "‚ùå DevSecOps deployment failed!"
          echo "Check the logs for more details"
          exit 1 