name: DevSecOps-K8s Security Pipeline

permissions:
  contents: read
  security-events: write

on:
  push:
    branches: [ devsecops-k8s ]
  pull_request:
    branches: [ devsecops-k8s ]

env:
  AWS_REGION: ap-northeast-2
  TF_VERSION: '1.5.0'

jobs:
  trivy-fs-scan:
    name: Trivy File System Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3
      - name: Run Trivy vulnerability scanner (File System)
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: 'devsecops-2'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH,MEDIUM,LOW'
      - name: Upload Trivy scan results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'
      - name: Upload Trivy FS results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: trivy-fs-results
          path: trivy-results.sarif
      - name: Generate Trivy FS Summary
        if: always()
        run: |
          echo "## ğŸ” Trivy File System Scan Results" >> $GITHUB_STEP_SUMMARY
          if [ -f trivy-results.sarif ]; then
            echo "âœ… File system scan completed successfully" >> $GITHUB_STEP_SUMMARY
            echo "ğŸ“ Results uploaded to GitHub Security tab" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ File system scan failed or no results generated" >> $GITHUB_STEP_SUMMARY
          fi



  trivy-configuration-layer:
    name: Configuration Layer - Trivy Multi-Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3
      
      - name: Install Trivy
        run: |
          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /usr/local/bin v0.64.1
          trivy --version
      
      - name: Debug Workspace Structure
        run: |
          echo "Current working directory:"
          pwd
          echo "Workspace structure:"
          ls -la
          echo "devsecops-k8s directory structure:"
          ls -la devsecops-k8s/
          echo "devsecops-k8s/terraform directory structure:"
          ls -la devsecops-k8s/terraform/
      
      # 1. IaC ìŠ¤ìº” (Terraform)
      - name: Run Trivy IaC Scan
        working-directory: devsecops-k8s/terraform
        run: |
          echo "ğŸ” Running Trivy IaC scan for Terraform..."
          trivy config . --format sarif --output trivy-iac-results.sarif --severity CRITICAL,HIGH,MEDIUM,LOW
          echo "âœ… IaC scan completed"
          ls -la trivy-iac-results.sarif || echo "âš ï¸ No IaC issues found"
      
      # 2. Kubernetes ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ìŠ¤ìº”
      - name: Run Trivy Kubernetes Config Scan
        run: |
          echo "ğŸ” Running Trivy Kubernetes config scan..."
          # k8s ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ë””ë ‰í† ë¦¬ ìƒì„± (ì˜ˆì‹œ)
          mkdir -p devsecops-k8s/k8s/manifests
          echo "# Sample Kubernetes manifest for testing" > devsecops-k8s/k8s/manifests/sample-deployment.yaml
          echo "apiVersion: apps/v1" >> devsecops-k8s/k8s/manifests/sample-deployment.yaml
          echo "kind: Deployment" >> devsecops-k8s/k8s/manifests/sample-deployment.yaml
          
          trivy config devsecops-k8s/k8s/manifests/ --format sarif --output trivy-config-results.sarif --severity CRITICAL,HIGH,MEDIUM,LOW
          echo "âœ… Kubernetes config scan completed"
          ls -la trivy-config-results.sarif || echo "âš ï¸ No Kubernetes config issues found"
      
      # 3. ì»¨í…Œì´ë„ˆ ì´ë¯¸ì§€ ìŠ¤ìº”
      - name: Run Trivy Container Image Scan
        run: |
          echo "ğŸ” Running Trivy container image scan..."
          # ìƒ˜í”Œ ì´ë¯¸ì§€ë¡œ ìŠ¤ìº” (nginx:latest)
          trivy image nginx:latest --format sarif --output trivy-image-results.sarif --severity CRITICAL,HIGH,MEDIUM,LOW
          echo "âœ… Container image scan completed"
          ls -la trivy-image-results.sarif || echo "âš ï¸ No container image issues found"
      
      # ê²°ê³¼ íŒŒì¼ ì—…ë¡œë“œ
      - name: Upload Trivy IaC Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: trivy-iac-results
          path: devsecops-k8s/terraform/trivy-iac-results.sarif
      
      - name: Upload Trivy Kubernetes Config Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: trivy-config-results
          path: trivy-config-results.sarif
      
      - name: Upload Trivy Container Image Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: trivy-image-results
          path: trivy-image-results.sarif
      
      # ì¢…í•© ìš”ì•½ ìƒì„±
      - name: Generate Configuration Layer Summary
        if: always()
        run: |
          echo "## ğŸ” Configuration Layer - Trivy Multi-Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“Š Scan Results:" >> $GITHUB_STEP_SUMMARY
          
          # IaC ìŠ¤ìº” ê²°ê³¼
          if [ -f devsecops-k8s/terraform/trivy-iac-results.sarif ]; then
            echo "âœ… **IaC Scan (Terraform)**: Completed" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **IaC Scan (Terraform)**: Failed or no results" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Kubernetes ìŠ¤ìº” ê²°ê³¼
          if [ -f trivy-config-results.sarif ]; then
            echo "âœ… **Kubernetes Config Scan**: Completed" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Kubernetes Config Scan**: Failed or no results" >> $GITHUB_STEP_SUMMARY
          fi
          
          # ì»¨í…Œì´ë„ˆ ì´ë¯¸ì§€ ìŠ¤ìº” ê²°ê³¼
          if [ -f trivy-image-results.sarif ]; then
            echo "âœ… **Container Image Scan**: Completed" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Container Image Scan**: Failed or no results" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“ Output Files:" >> $GITHUB_STEP_SUMMARY
          echo "- `trivy-iac-results.sarif`: Terraform IaC scan results" >> $GITHUB_STEP_SUMMARY
          echo "- `trivy-config-results.sarif`: Kubernetes config scan results" >> $GITHUB_STEP_SUMMARY
          echo "- `trivy-image-results.sarif`: Container image scan results" >> $GITHUB_STEP_SUMMARY

  ai-security-report:
    name: AI Security Report
    runs-on: ubuntu-latest
    needs: [trivy-fs-scan, trivy-configuration-layer]
    if: always()
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
      
      # ë‹¤ìš´ë¡œë“œ ëª¨ë“  Trivy ê²°ê³¼
      - name: Download Trivy FS results
        uses: actions/download-artifact@v4
        if: needs.trivy-fs-scan.result == 'success'
        with:
          name: trivy-fs-results
          path: .
      
      - name: Download Trivy IaC results
        uses: actions/download-artifact@v4
        if: needs.trivy-configuration-layer.result == 'success'
        with:
          name: trivy-iac-results
          path: .
      
      - name: Download Trivy Kubernetes Config results
        uses: actions/download-artifact@v4
        if: needs.trivy-configuration-layer.result == 'success'
        with:
          name: trivy-config-results
          path: .
      
      - name: Download Trivy Container Image results
        uses: actions/download-artifact@v4
        if: needs.trivy-configuration-layer.result == 'success'
        with:
          name: trivy-image-results
          path: .


      - name: Debug Workspace Structure for AI Report
        run: |
          echo "Current working directory:"
          pwd
          echo "Workspace structure:"
          ls -la
          echo "devsecops-k8s directory structure:"
          ls -la devsecops-k8s/
          echo "Looking for generate_security_report.py:"
          find . -name "generate_security_report.py" -type f
          echo "Available Trivy result files:"
          ls -la *.sarif || echo "No SARIF files found"
      
      - name: Copy Trivy results to devsecops-k8s directory
        run: |
          mkdir -p devsecops-k8s/trivy-results
          # ëª¨ë“  SARIF íŒŒì¼ì„ ë³µì‚¬
          if [ -f trivy-results.sarif ]; then
            cp trivy-results.sarif devsecops-k8s/trivy-results/
          fi
          if [ -f trivy-iac-results.sarif ]; then
            cp trivy-iac-results.sarif devsecops-k8s/trivy-results/
          fi
          if [ -f trivy-config-results.sarif ]; then
            cp trivy-config-results.sarif devsecops-k8s/trivy-results/
          fi
          if [ -f trivy-image-results.sarif ]; then
            cp trivy-image-results.sarif devsecops-k8s/trivy-results/
          fi
          echo "Copied Trivy results to devsecops-k8s/trivy-results/"

      - name: Generate AI Security Report
        run: |
          cd devsecops-k8s
          if [ -f generate_security_report.py ]; then
            python3 generate_security_report.py
          else
            echo "generate_security_report.py not found, skipping AI report generation"
          fi
      - name: Upload AI Security Report
        uses: actions/upload-artifact@v4
        if: hashFiles('devsecops-k8s/trivy-security-report.md') != ''
        with:
          name: trivy-ai-security-report
          path: devsecops-k8s/trivy-security-report.md
      - name: Generate Final AI Summary
        run: |
          echo "## ğŸ¤– AI Security Scan Complete" >> $GITHUB_STEP_SUMMARY
          echo "### Overall Status: âœ… PASSED" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“‹ Job Results:" >> $GITHUB_STEP_SUMMARY
          echo "- Trivy File System Scan: ${{ needs.trivy-fs-scan.result }}" >> $GITHUB_STEP_SUMMARY

          echo "### ğŸ“Š Reports Available:" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ¤– AI Security Report (trivy-security-report.md)" >> $GITHUB_STEP_SUMMARY
          echo "- GitHub Security Tab" >> $GITHUB_STEP_SUMMARY
          echo "- Workflow Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "- Trivy FS Results: trivy-results.sarif" >> $GITHUB_STEP_SUMMARY



  deploy-3-layer-security:
    name: Deploy 3-Layer Security Infrastructure
    runs-on: ubuntu-latest
    needs: [ai-security-report]
    if: needs.ai-security-report.result == 'success'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
      
      # 5. Terraform Apply
      - name: Terraform Apply
        working-directory: devsecops-k8s/terraform
        run: |
          terraform init
          terraform apply -auto-approve
      
      - name: Save Terraform outputs
        working-directory: devsecops-k8s/terraform
        run: |
          if [ -f "save_outputs.sh" ]; then
            chmod +x save_outputs.sh
            ./save_outputs.sh
          fi
      
      - name: Configure kubectl
        run: |
          aws eks update-kubeconfig --region ap-northeast-2 --name devsecops-eks-cluster
          kubectl cluster-info
      
      # 6. Trivy ìŠ¤ìº” (Configuration Layer)
      - name: Run Configuration Layer Scans
        run: |
          cd devsecops-k8s
          chmod +x run-trivy-scans.sh
          ./run-trivy-scans.sh
      
      # 7. Falco & Gatekeeper ë°°í¬ (Runtime & Policy Layer)
      - name: Deploy Runtime Layer (Falco)
        run: |
          kubectl apply -f devsecops-k8s/k8s/manifests/falco-daemonset.yaml
          kubectl wait --for=condition=ready pod -l app=falco -n falco --timeout=300s
          echo "âœ… Falco Runtime Layer ë°°í¬ ì™„ë£Œ"
      
      - name: Deploy Policy Layer (Gatekeeper)
        run: |
          cd devsecops-k8s
          chmod +x install-gatekeeper.sh
          ./install-gatekeeper.sh
          echo "âœ… Gatekeeper Policy Layer ë°°í¬ ì™„ë£Œ"
      
      # 8. LLM ë³´ê³ ì„œ ìƒì„± & ê²Œì‹œ
      - name: Generate 3-Layer Security Report
        run: |
          cd devsecops-k8s
          python3 generate_security_report.py
          echo "âœ… 3ê³„ì¸µ ë³´ì•ˆ ë³´ê³ ì„œ ìƒì„± ì™„ë£Œ"
      
      - name: Upload 3-Layer Security Report
        uses: actions/upload-artifact@v4
        with:
          name: 3-layer-security-report
          path: devsecops-k8s/trivy-security-report.md
      
      # PR ì½”ë©˜íŠ¸ë¡œ ë³´ê³ ì„œ ê²Œì‹œ
      - name: Comment PR with Security Report
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            const reportPath = 'devsecops-k8s/trivy-security-report.md';
            
            if (fs.existsSync(reportPath)) {
              const report = fs.readFileSync(reportPath, 'utf8');
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: `## ğŸ”’ 3ê³„ì¸µ ë³´ì•ˆ ìŠ¤ìº” ê²°ê³¼\n\n${report}`
              });
            } else {
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: '## âš ï¸ ë³´ì•ˆ ë³´ê³ ì„œ ìƒì„± ì‹¤íŒ¨\n\në³´ì•ˆ ìŠ¤ìº” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'
              });
            }

  notify:
    name: Notify 3-Layer Security Status
    runs-on: ubuntu-latest
    needs: [deploy-3-layer-security, ai-security-report]
    if: always()
    steps:
      - name: Notify on Success
        if: needs.deploy-3-layer-security.result == 'success' && needs.ai-security-report.result == 'success'
        run: |
          echo "âœ… 3ê³„ì¸µ ë³´ì•ˆ ëª¨ë¸ ë°°í¬ ì™„ë£Œ!"
          echo "Configuration, Runtime, Policy Layer ëª¨ë‘ ì„±ê³µì ìœ¼ë¡œ ë°°í¬ë˜ì—ˆìŠµë‹ˆë‹¤"
      - name: Notify on Failure
        if: needs.deploy-3-layer-security.result == 'failure' || needs.ai-security-report.result == 'failure'
        run: |
          echo "âŒ 3ê³„ì¸µ ë³´ì•ˆ ëª¨ë¸ ë°°í¬ ì‹¤íŒ¨!"
          echo "ë¡œê·¸ë¥¼ í™•ì¸í•˜ì—¬ ë¬¸ì œë¥¼ í•´ê²°í•˜ì„¸ìš”"
